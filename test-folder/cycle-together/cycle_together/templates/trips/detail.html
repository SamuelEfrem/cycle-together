{% extends 'base.html' %}

{% block content %}
<div class="trip-detail">
    <div class="trip-detail-header">
        <div>
            <h2>{{ trip.title }}</h2>
            <div class="trip-badges">
                <span class="status-badge status-{{ trip.status.name }}">
                    {{ trip.status.name.replace('_', ' ').title() }}
                </span>
                <span class="difficulty-badge difficulty-{{ trip.difficulty.name }}">
                    {{ trip.difficulty.name.capitalize() }}
                </span>
            </div>
        </div>
        <div class="trip-actions">
            {% if participation.can_edit and trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
                <a href="{{ url_for('trips.edit', trip_id=trip.id) }}" class="btn btn-secondary">Edit Trip</a>
            {% endif %}
            <form action="{{ url_for('trips.leave', trip_id=trip.id) }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to leave this trip?')">Leave Trip</button>
            </form>
        </div>
    </div>

    <div class="trip-detail-content">
        <div class="trip-main">
            <section class="detail-section">
                <h3>Description</h3>
                <p>{{ trip.description }}</p>
            </section>

            <section class="detail-section">
                <h3>Route Details</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Departure:</strong> {{ trip.departure_location }}
                        {% if trip.departure_final %}<span class="locked-badge">üîí Final</span>{% endif %}
                    </div>
                    <div class="detail-item">
                        <strong>Destination:</strong> {{ trip.destination }}
                        {% if trip.destination_final %}<span class="locked-badge">üîí Final</span>{% endif %}
                    </div>
                    <div class="detail-item">
                        <strong>Distance:</strong> {{ trip.distance_km }} km
                    </div>
                    <div class="detail-item">
                        <strong>Difficulty:</strong> {{ trip.difficulty.name.capitalize() }}
                    </div>
                </div>
                
                {% if trip.route_description %}
                <div class="detail-item-full">
                    <strong>Route Description:</strong> {{ trip.route_description }}
                    {% if trip.route_final %}<span class="locked-badge">üîí Final</span>{% endif %}
                </div>
                {% endif %}

                {% if participation.can_edit and trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
                <div class="lock-actions">
                    <form action="{{ url_for('trips.lock_field', trip_id=trip.id) }}" method="post" style="display:inline;">
                        <input type="hidden" name="field" value="departure">
                        <button type="submit" class="btn btn-sm btn-outline" {% if trip.departure_final %}disabled{% endif %}>
                            Lock Departure
                        </button>
                    </form>
                    <form action="{{ url_for('trips.lock_field', trip_id=trip.id) }}" method="post" style="display:inline;">
                        <input type="hidden" name="field" value="destination">
                        <button type="submit" class="btn btn-sm btn-outline" {% if trip.destination_final %}disabled{% endif %}>
                            Lock Destination
                        </button>
                    </form>
                    <form action="{{ url_for('trips.lock_field', trip_id=trip.id) }}" method="post" style="display:inline;">
                        <input type="hidden" name="field" value="route">
                        <button type="submit" class="btn btn-sm btn-outline" {% if trip.route_final %}disabled{% endif %}>
                            Lock Route
                        </button>
                    </form>
                </div>
                {% endif %}
            </section>

            <section class="detail-section">
                <h3>Dates & Duration</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Start Date Range:</strong> 
                        {{ trip.start_date_min.strftime('%B %d') }} - {{ trip.start_date_max.strftime('%B %d, %Y') }}
                        {% if trip.dates_final %}<span class="locked-badge">üîí Final</span>{% endif %}
                    </div>
                    <div class="detail-item">
                        <strong>Duration:</strong> {{ trip.duration_days_min }}-{{ trip.duration_days_max }} days
                    </div>
                </div>

                {% if participation.can_edit and not trip.dates_final and trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
                <form action="{{ url_for('trips.lock_field', trip_id=trip.id) }}" method="post" style="margin-top:1rem;">
                    <input type="hidden" name="field" value="dates">
                    <button type="submit" class="btn btn-sm btn-outline">Lock Dates</button>
                </form>
                {% endif %}
            </section>

            <section class="detail-section">
                <h3>Budget</h3>
                <div class="detail-item">
                    <strong>Per Person:</strong> ‚Ç¨{{ trip.budget_per_person }}
                    {% if trip.budget_final %}<span class="locked-badge">üîí Final</span>{% endif %}
                </div>

                {% if participation.can_edit and not trip.budget_final and trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
                <form action="{{ url_for('trips.lock_field', trip_id=trip.id) }}" method="post" style="margin-top:1rem;">
                    <input type="hidden" name="field" value="budget">
                    <button type="submit" class="btn btn-sm btn-outline">Lock Budget</button>
                </form>
                {% endif %}
            </section>

            {% if participation.can_edit and trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
            <section class="detail-section">
                <h3>Trip Management</h3>
                <div class="management-actions">
                    {% if trip.status == trip.status.__class__.open %}
                    <form action="{{ url_for('trips.close_trip', trip_id=trip.id) }}" method="post">
                        <button type="submit" class="btn btn-warning">Close to New Participants</button>
                    </form>
                    {% endif %}
                    
                    <form action="{{ url_for('trips.finalize', trip_id=trip.id) }}" method="post">
                        <button type="submit" class="btn btn-success" onclick="return confirm('Finalize this trip? No more changes will be allowed.')">
                            Finalize Trip
                        </button>
                    </form>
                    
                    <form action="{{ url_for('trips.cancel', trip_id=trip.id) }}" method="post">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Cancel this trip?')">
                            Cancel Trip
                        </button>
                    </form>
                </div>
            </section>
            {% endif %}

            <section class="detail-section">
                <h3>Meetups</h3>
                
                {% if meetups %}
                <div class="meetups-list">
                    {% for meetup in meetups %}
                    <div class="meetup-item">
                        <div class="meetup-info">
                            <h4>{{ meetup.title }}</h4>
                            <p><strong>üìç</strong> {{ meetup.location }}</p>
                            <p><strong>üìÖ</strong> {{ meetup.meetup_datetime.strftime('%B %d, %Y at %H:%M') }}</p>
                            {% if meetup.description %}
                            <p>{{ meetup.description }}</p>
                            {% endif %}
                            <small>Created by <a href="{{ url_for('auth.view_user', user_id=meetup.creator.id) }}">{{ meetup.creator.name }}</a></small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>No meetups scheduled yet.</p>
                {% endif %}

                {% if participation.can_edit and trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
                <details class="create-meetup-form">
                    <summary class="btn btn-secondary btn-sm">Schedule New Meetup</summary>
                    <form action="{{ url_for('trips.create_meetup', trip_id=trip.id) }}" method="post" class="form" style="margin-top:1rem;">
                        <div class="form-group">
                            <label for="title">Meetup Title</label>
                            <input type="text" id="title" name="title" required placeholder="e.g., Pre-trip bike check">
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" required placeholder="e.g., Central Park Entrance">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="meetup_date">Date</label>
                                <input type="date" id="meetup_date" name="meetup_date" required>
                            </div>
                            <div class="form-group">
                                <label for="meetup_time">Time</label>
                                <input type="time" id="meetup_time" name="meetup_time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="description">Description (Optional)</label>
                            <textarea id="description" name="description" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Meetup</button>
                    </form>
                </details>
                {% endif %}
            </section>

            <section class="detail-section">
                <h3>Message Board</h3>
                
                {% if trip.status not in [trip.status.__class__.finalized, trip.status.__class__.cancelled] %}
                <form action="{{ url_for('trips.post_message', trip_id=trip.id) }}" method="post" class="message-form">
                    <textarea name="text" required placeholder="Share your thoughts, questions, or ideas..." rows="3"></textarea>
                    <button type="submit" class="btn btn-primary">Post Message</button>
                </form>
                {% endif %}

                <div class="messages-list">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="message-item">
                            <div class="message-header">
                                <a href="{{ url_for('auth.view_user', user_id=message.author.id) }}" class="message-author">
                                    {{ message.author.name }}
                                </a>
                                <span class="message-time">{{ message.created_at.strftime('%b %d, %Y at %H:%M') }}</span>
                            </div>
                            <div class="message-text">{{ message.text }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-messages">No messages yet. Start the conversation!</p>
                    {% endif %}
                </div>
            </section>
        </div>

        <aside class="trip-sidebar">
            <section class="sidebar-section">
                <h3>Participants ({{ trip.participations|length }}/{{ trip.max_participants }})</h3>
                <div class="participants-list">
                    {% for p in trip.participations %}
                    <div class="participant-item">
                        <a href="{{ url_for('auth.view_user', user_id=p.user.id) }}" class="participant-name">
                            {{ p.user.name }}
                        </a>
                        {% if p.user.id == trip.creator_id %}
                        <span class="badge badge-creator">Creator</span>
                        {% endif %}
                        {% if p.can_edit %}
                        <span class="badge badge-editor">Editor</span>
                        {% endif %}
                        
                        {% if trip.creator_id == current_user.id and p.user.id != current_user.id %}
                        <form action="{{ url_for('trips.toggle_permissions', trip_id=trip.id, user_id=p.user.id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn-icon" title="Toggle edit permission">
                                {% if p.can_edit %}üîì{% else %}üîí{% endif %}
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="sidebar-section">
                <h3>Trip Creator</h3>
                <a href="{{ url_for('auth.view_user', user_id=trip.creator.id) }}" class="creator-link">
                    {{ trip.creator.name }}
                </a>
            </section>
        </aside>
    </div>
</div>
{% endblock %}